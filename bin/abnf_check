#!/usr/bin/env node
// -*- js -*-

"use strict";

const abnf = require("../lib/abnf");

function check_refs(er, rules) {
  if (er) {
    console.error("At line:", rules.line);
    console.error(er);
    return;
  }
  rules.refs.forEach(ref => {
    if (!Object.prototype.hasOwnProperty.call(
      rules.defs,
      ref.name.toUpperCase()
    )) {
      console.log("Unknown reference: '" + ref.name + "' at line " + ref.line);
    }
  });
  for (const name in rules.defs) {
    if ((rules.findRefs(name).length === 0) && (name !== rules.first)) {
      console.log("Unreferenced: '" + name + "' at line " + rules.defs[name].line);
    }
  }
}

const args = process.argv.slice(2);
if (args.length === 0) {
  abnf.parse(process.stdin, check_refs);
  process.stdin.resume();
} else {
  args.forEach(a => abnf.parseFile(a, check_refs));
}
